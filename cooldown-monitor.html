<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cooldown Monitor - World of Words</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        
        .config-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .config-item h3 {
            margin-top: 0;
            color: #28a745;
        }
        
        .stats-container {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .controls {
            margin-bottom: 20px;
        }
        
        .controls button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .controls button:hover {
            background: #218838;
        }
        
        .controls button.danger {
            background: #dc3545;
        }
        
        .controls button.danger:hover {
            background: #c82333;
        }
        
        .controls input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }
        
        .cooldown-active {
            background: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }
        
        .cooldown-active h4 {
            color: #856404;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        #testResults {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .cooldown-timer {
            font-weight: bold;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚è∞ Cooldown Anti-Spam Monitor</h1>
        
        <div class="section">
            <h2>‚öôÔ∏è Configuration</h2>
            <div class="config-item">
                <h3>Cooldown Anti-Spam</h3>
                <p><strong>Dur√©e:</strong> 5 secondes entre les messages</p>
                <p><strong>Violations max:</strong> 3 tentatives avant p√©nalit√©</p>
                <p><strong>P√©nalit√©:</strong> 60 secondes de blocage</p>
                <p><em>Syst√®me l√©ger pour emp√™cher le spam rapide</em></p>
            </div>
        </div>
        
        <div class="section">
            <h2>üìä M√©triques Globales</h2>
            <div class="metrics" id="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="totalClients">0</div>
                    <div class="metric-label">Total Clients</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="activeClients">0</div>
                    <div class="metric-label">Clients Actifs</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="clientsOnCooldown">0</div>
                    <div class="metric-label">En Cooldown</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalViolations">0</div>
                    <div class="metric-label">Violations Totales</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>üéõÔ∏è Contr√¥les</h2>
            <div class="controls">
                <button onclick="refreshStats()">üîÑ Actualiser</button>
                <button onclick="resetAllCooldowns()" class="danger">üóëÔ∏è Reset Tous</button>
                <input type="text" id="clientIdInput" placeholder="Client ID">
                <button onclick="resetSpecificCooldown()">üîì Reset Client</button>
                <button onclick="applyPenalty()" class="danger">‚ö° Appliquer P√©nalit√©</button>
            </div>
            <div id="status"></div>
        </div>
        
        <div class="section">
            <h2>üìä Cooldowns Actifs</h2>
            <div class="stats-container" id="cooldowns">
                <p>Chargement...</p>
            </div>
        </div>
        
        <div class="section">
            <h2>üß™ Zone de Test</h2>
            <div class="controls">
                <button onclick="connectTestClient()">üîå Se Connecter</button>
                <button onclick="testCooldown()">‚è∞ Test Cooldown</button>
                <button onclick="testViolations()">‚ö†Ô∏è Test Violations</button>
                <button onclick="checkCooldownStatus()">üìä V√©rifier Statut</button>
            </div>
            <div id="testResults"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let testSocket = null;
        
        // Actualiser les stats automatiquement
        setInterval(refreshStats, 3000);
        refreshStats(); // Charger imm√©diatement
        
        async function refreshStats() {
            try {
                const response = await fetch('/admin/cooldown/stats');
                const data = await response.json();
                displayStats(data);
            } catch (error) {
                showStatus('Erreur lors du chargement des stats: ' + error.message, 'error');
            }
        }
        
        function displayStats(data) {
            // Mettre √† jour les m√©triques
            const metrics = data.metrics;
            document.getElementById('totalClients').textContent = metrics.totalClients;
            document.getElementById('activeClients').textContent = metrics.activeClients;
            document.getElementById('clientsOnCooldown').textContent = metrics.clientsOnCooldown;
            document.getElementById('totalViolations').textContent = metrics.totalViolations;
            
            // Afficher les cooldowns individuels
            const cooldownsDiv = document.getElementById('cooldowns');
            const cooldowns = data.cooldowns;
            
            if (Object.keys(cooldowns).length === 0) {
                cooldownsDiv.innerHTML = '<p>Aucun cooldown actif.</p>';
                return;
            }
            
            let html = '<div style="font-size: 12px; color: #666; margin-bottom: 10px;">Derni√®re mise √† jour: ' + 
                      new Date(data.timestamp).toLocaleString() + '</div>';
            
            Object.entries(cooldowns).forEach(([clientId, stats]) => {
                const isOnCooldown = stats.isOnCooldown;
                
                html += `
                    <div class="${isOnCooldown ? 'cooldown-active' : ''}" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <h4>Client: ${clientId}</h4>
                        <p><strong>Messages:</strong> ${stats.messageCount}</p>
                        <p><strong>Violations:</strong> ${stats.violations}</p>
                        ${isOnCooldown ? 
                            `<p><strong>‚è∞ COOLDOWN ACTIF:</strong> <span class="cooldown-timer">${stats.remainingCooldown}s restants</span></p>` : 
                            `<p><strong>Statut:</strong> ‚úÖ Peut envoyer</p>`
                        }
                        <p><strong>Dernier message:</strong> ${new Date(stats.lastMessageTime).toLocaleTimeString()}</p>
                        <p><strong>Temps √©coul√©:</strong> ${stats.timeSinceLastMessage}s</p>
                    </div>
                `;
            });
            
            cooldownsDiv.innerHTML = html;
        }
        
        async function resetAllCooldowns() {
            if (!confirm('√ätes-vous s√ªr de vouloir r√©initialiser tous les cooldowns ?')) return;
            
            try {
                const response = await fetch('/admin/cooldown/all', { method: 'DELETE' });
                const result = await response.json();
                showStatus(result.message, 'success');
                refreshStats();
            } catch (error) {
                showStatus('Erreur: ' + error.message, 'error');
            }
        }
        
        async function resetSpecificCooldown() {
            const clientId = document.getElementById('clientIdInput').value;
            if (!clientId) {
                showStatus('Veuillez entrer un Client ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/admin/cooldown/reset/${clientId}`, { method: 'POST' });
                const result = await response.json();
                showStatus(result.message, 'success');
                refreshStats();
            } catch (error) {
                showStatus('Erreur: ' + error.message, 'error');
            }
        }
        
        async function applyPenalty() {
            const clientId = document.getElementById('clientIdInput').value;
            if (!clientId) {
                showStatus('Veuillez entrer un Client ID', 'error');
                return;
            }
            
            const reason = prompt('Raison de la p√©nalit√© (optionnel):', 'Manual penalty from admin panel');
            
            try {
                const response = await fetch(`/admin/cooldown/penalty/${clientId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: reason || 'Manual penalty' })
                });
                const result = await response.json();
                showStatus(result.message, 'success');
                refreshStats();
            } catch (error) {
                showStatus('Erreur: ' + error.message, 'error');
            }
        }
        
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 3000);
        }
        
        // Fonctions de test
        function connectTestClient() {
            if (testSocket) {
                testSocket.disconnect();
            }
            
            testSocket = io();
            
            testSocket.on('connect', () => {
                showTestResult('‚úÖ Client de test connect√©: ' + testSocket.id);
            });
            
            testSocket.on('cooldownViolation', (data) => {
                showTestResult(`üö´ Violation cooldown: ${data.reason} (${data.remainingCooldown}s)`);
            });
            
            testSocket.on('cooldownActive', (data) => {
                showTestResult(`‚è≥ Cooldown actif: ${data.remainingCooldown}s restants`);
            });
            
            testSocket.on('quickResponse', (data) => {
                showTestResult(`‚úÖ Message accept√©: ${data.message}`);
            });
            
            testSocket.on('cooldownStatusResponse', (data) => {
                const stats = data.cooldownStats;
                showTestResult(`üìä Statut: ${stats.isOnCooldown ? '‚è≥ En cooldown (' + stats.remainingCooldown + 's)' : '‚úÖ Libre'} - Messages: ${stats.messageCount}, Violations: ${stats.violations}`);
            });
        }
        
        function testCooldown() {
            if (!testSocket || !testSocket.connected) {
                showTestResult('‚ùå Aucun client connect√©');
                return;
            }
            
            showTestResult('‚è∞ Test du cooldown - Envoi de 3 messages rapides...');
            
            // Envoyer 3 messages rapidement
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    testSocket.emit('quickMessage', { 
                        message: `Test cooldown ${i + 1}`,
                        timestamp: new Date().toISOString()
                    });
                    showTestResult(`üì§ Message ${i + 1} envoy√©`);
                }, i * 1000);
            }
        }
        
        function testViolations() {
            if (!testSocket || !testSocket.connected) {
                showTestResult('‚ùå Aucun client connect√©');
                return;
            }
            
            showTestResult('‚ö†Ô∏è Test des violations - Envoi de 6 messages tr√®s rapidement...');
            
            // Envoyer plusieurs messages tr√®s rapidement pour d√©clencher des violations
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    testSocket.emit('quickMessage', { 
                        message: `Violation test ${i + 1}`,
                        timestamp: new Date().toISOString()
                    });
                    showTestResult(`üì§ Message violation ${i + 1} envoy√©`);
                }, i * 200); // Tr√®s rapide : toutes les 200ms
            }
        }
        
        function checkCooldownStatus() {
            if (!testSocket || !testSocket.connected) {
                showTestResult('‚ùå Aucun client connect√©');
                return;
            }
            
            testSocket.emit('getCooldownStatus', {});
            showTestResult('üìä Demande du statut du cooldown...');
        }
        
        function showTestResult(message) {
            const resultsDiv = document.getElementById('testResults');
            const time = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `<div style="margin: 2px 0;"><strong>[${time}]</strong> ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
    </script>
</body>
</html>
